<div class="promotions-container">
    <!-- Encabezado de la sección -->
    <nz-card nzTitle="Gestión de Promociones y Cupones" class="mb-4 header-card">
        <div class="card-actions">
            <button nz-button nzType="primary" (click)="openCreatePromotionModal()">
                <span nz-icon nzType="plus"></span>
                <span class="button-text">Nueva Promoción / Cupón</span>
            </button>
        </div>
    </nz-card>

    <nz-card *ngIf="!loading">
        <nz-table #promotionsTable [nzData]="promotions" [nzBordered]="true" [nzShowPagination]="promotions.length > 10"
            [nzPageSize]="10" *ngIf="promotions.length > 0">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Tipo General</th>
                    <th>Código</th>
                    <th>Descuento</th>
                    <th>Fechas</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let promotion of promotionsTable.data">
                    <td>
                        <div class="promotion-name">
                            <strong>{{ promotion.name }}</strong>
                            <div *ngIf="promotion.description" class="promotion-description">
                                {{ promotion.description }}
                            </div>
                        </div>
                    </td>
                    <td>
                        <!-- ✅ Muestra si es Estándar o Cupón -->
                        <nz-tag [nzColor]="promotion.promotionType === 'coupon' ? 'gold' : 'blue'">
                            {{ promotion.promotionType === 'coupon' ? 'Cupón' : 'Estándar' }}
                        </nz-tag>
                    </td>
                    <td>
                        <!-- ✅ Muestra el código del cupón si existe -->
                        <span *ngIf="promotion.couponCode; else noCode">
                            <code>{{ promotion.couponCode }}</code>
                        </span>
                        <ng-template #noCode>
                            <span style="color: #999;">N/A</span>
                        </ng-template>
                    </td>
                    <td>{{ formatDiscountValue(promotion) }}</td>
                    <td>{{ formatDate(promotion.startDate) }} - {{ formatDate(promotion.endDate) }}</td>
                    <td>
                        <nz-tag [nzColor]="promotion.isActive ? 'green' : 'default'">
                            {{ promotion.isActive ? 'Activa' : 'Inactiva' }}
                        </nz-tag>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button nz-button nzType="primary" nzSize="small"
                                (click)="openEditPromotionModal(promotion)" nz-tooltip nzTooltipTitle="Editar">
                                <span nz-icon nzType="edit"></span>
                            </button>
                            <button nz-button nzType="primary" nzDanger nzSize="small" nz-popconfirm
                                nzPopconfirmTitle="¿Está seguro de eliminar esta promoción?"
                                nzPopconfirmPlacement="bottom" (nzOnConfirm)="deletePromotion(promotion.id)" nz-tooltip
                                nzTooltipTitle="Eliminar">
                                <span nz-icon nzType="delete"></span>
                            </button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </nz-table>
    </nz-card>
</div>

<!-- Modal de formulario para crear/editar promoción -->
<nz-modal [(nzVisible)]="formModalVisible" [nzTitle]="isEditMode ? 'Editar Promoción' : 'Nueva Promoción'"
    [nzWidth]="800" [nzOkText]="'Guardar'" [nzCancelText]="'Cancelar'" [nzOkLoading]="submitting"
    (nzOnCancel)="closeFormModal()" (nzOnOk)="submitForm()">
    <ng-container *nzModalContent>
        <form [formGroup]="promotionForm" nz-form [nzLayout]="'vertical'">
            <!-- ✅ SELECCIÓN DE TIPO DE PROMOCIÓN -->
            <nz-form-item>
                <nz-form-label nzRequired>Tipo General de Promoción</nz-form-label>
                <nz-form-control>
                    <nz-radio-group formControlName="promotionType">
                        <label nz-radio-button nzValue="standard">Promoción Estándar</label>
                        <label nz-radio-button nzValue="coupon">Código de Descuento (Cupón)</label>
                    </nz-radio-group>
                </nz-form-control>
            </nz-form-item>

            <nz-divider></nz-divider>

            <div nz-row [nzGutter]="16">
                <!-- Columna Izquierda: Detalles Básicos -->
                <div nz-col [nzXs]="24" [nzSm]="12">
                    <nz-form-item>
                        <nz-form-label nzRequired>Nombre</nz-form-label>
                        <nz-form-control nzErrorTip="Por favor ingrese un nombre (mín. 5 caracteres)">
                            <input nz-input formControlName="name" placeholder="Ej: Descuento de Verano" />
                        </nz-form-control>
                    </nz-form-item>

                    <nz-form-item>
                        <nz-form-label>Descripción</nz-form-label>
                        <nz-form-control><textarea nz-input formControlName="description" [nzAutosize]="{ minRows: 2, maxRows: 4 }"></textarea></nz-form-control>
                    </nz-form-item>

                    <nz-form-item>
                        <nz-form-label nzRequired>Tipo de Descuento</nz-form-label>
                        <nz-form-control>
                            <nz-select formControlName="discountType">
                                <nz-option nzValue="percentage" nzLabel="Porcentaje (%)"></nz-option>
                                <nz-option nzValue="fixed" nzLabel="Monto Fijo ($)"></nz-option>
                                <nz-option nzValue="shipping" nzLabel="Envío Gratis"></nz-option>
                            </nz-select>
                        </nz-form-control>
                    </nz-form-item>

                    <nz-form-item *ngIf="promotionForm.get('discountType')?.value !== 'shipping'">
                        <nz-form-label nzRequired>Valor del Descuento</nz-form-label>
                        <nz-form-control nzErrorTip="Ingrese un valor válido">
                            <nz-input-number formControlName="discountValue" [nzMin]="0" [nzStep]="1" style="width: 100%;"></nz-input-number>
                        </nz-form-control>
                    </nz-form-item>
                    
                    <nz-form-item>
                        <nz-form-label>Monto Mínimo de Compra ($)</nz-form-label>
                        <nz-form-control><nz-input-number formControlName="minPurchaseAmount" [nzMin]="0" style="width: 100%;"></nz-input-number></nz-form-control>
                    </nz-form-item>
                </div>

                <!-- Columna Derecha: Fechas y Estado -->
                <div nz-col [nzXs]="24" [nzSm]="12">
                    <nz-form-item>
                        <nz-form-label nzRequired>Fecha de Inicio</nz-form-label>
                        <nz-form-control nzErrorTip="Seleccione una fecha de inicio"><nz-date-picker formControlName="startDate" style="width: 100%;"></nz-date-picker></nz-form-control>
                    </nz-form-item>

                    <nz-form-item>
                        <nz-form-label nzRequired>Fecha de Fin</nz-form-label>
                        <nz-form-control nzErrorTip="Seleccione una fecha de fin"><nz-date-picker formControlName="endDate" style="width: 100%;"></nz-date-picker></nz-form-control>
                    </nz-form-item>
                    
                    <nz-form-item>
                        <nz-form-label>Estado</nz-form-label>
                        <nz-form-control><nz-switch formControlName="isActive" nzCheckedChildren="Activa" nzUnCheckedChildren="Inactiva"></nz-switch></nz-form-control>
                    </nz-form-item>
                </div>
            </div>

            <!-- ✅ SECCIÓN CONDICIONAL PARA CUPONES -->
            <div *ngIf="promotionForm.get('promotionType')?.value === 'coupon'">
                <nz-divider nzText="Configuración del Cupón" nzOrientation="left"></nz-divider>
                <div nz-row [nzGutter]="16">
                    <div nz-col [nzXs]="24" [nzSm]="12">
                        <nz-form-item>
                            <nz-form-label nzRequired>Código del Cupón</nz-form-label>
                            <nz-form-control nzErrorTip="El código es requerido, 4+ caracteres, solo mayúsculas y números (ej: VERANO25)">
                                <input nz-input formControlName="couponCode" placeholder="BIENVENIDA10" />
                            </nz-form-control>
                        </nz-form-item>
                    </div>
                    <div nz-col [nzXs]="24" [nzSm]="12">
                        <nz-form-item>
                            <nz-form-label>Tipo de Uso del Cupón</nz-form-label>
                            <nz-form-control>
                                <nz-select formControlName="couponType" nzPlaceHolder="Seleccione un tipo de uso">
                                    <nz-option *ngFor="let type of couponTypes" [nzValue]="type.value" [nzLabel]="type.label"></nz-option>
                                </nz-select>
                            </nz-form-control>
                        </nz-form-item>
                    </div>
                    <div nz-col [nzXs]="24" [nzSm]="12">
                        <nz-form-item>
                            <nz-form-label>Límite de Usos Globales</nz-form-label>
                            <nz-form-control nzErrorTip="Debe ser un número mayor a 0">
                                <nz-input-number formControlName="usageLimits.global" [nzMin]="1" placeholder="Ej: 100 (usos totales)" style="width: 100%;"></nz-input-number>
                            </nz-form-control>
                        </nz-form-item>
                    </div>
                    <div nz-col [nzXs]="24" [nzSm]="12">
                        <nz-form-item>
                            <nz-form-label>Límite de Usos por Usuario</nz-form-label>
                            <nz-form-control nzErrorTip="Debe ser un número mayor a 0">
                                <nz-input-number formControlName="usageLimits.perUser" [nzMin]="1" placeholder="Ej: 1 (un solo uso por cliente)" style="width: 100%;"></nz-input-number>
                            </nz-form-control>
                        </nz-form-item>
                    </div>
                </div>
            </div>
        </form>
    </ng-container>
</nz-modal>
