<div class="promotions-container">
    <!-- Encabezado de la sección -->
    <nz-card nzTitle="Gestión de Promociones y Cupones" class="mb-4 header-card">
        <div class="card-actions">
            <button nz-button nzType="primary" (click)="openCreatePromotionModal()">
                <span nz-icon nzType="plus"></span>
                <span class="button-text">Nueva Promoción / Cupón</span>
            </button>
        </div>
    </nz-card>

    <nz-card *ngIf="!loading">
        <nz-table #promotionsTable [nzData]="promotions" [nzBordered]="true" [nzShowPagination]="promotions.length > 10"
            [nzPageSize]="10" *ngIf="promotions.length > 0">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Tipo General</th>
                    <th>Código</th>
                    <th>Descuento</th>
                    <th>Fechas</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let promotion of promotionsTable.data">
                    <td>
                        <div class="promotion-name">
                            <strong>{{ promotion.name }}</strong>
                            <div *ngIf="promotion.description" class="promotion-description">
                                {{ promotion.description }}
                            </div>
                        </div>
                    </td>
                    <td>
                        <!-- ✅ Muestra si es Estándar o Cupón -->
                        <nz-tag [nzColor]="promotion.promotionType === 'coupon' ? 'gold' : 'blue'">
                            {{ promotion.promotionType === 'coupon' ? 'Cupón' : 'Estándar' }}
                        </nz-tag>
                    </td>
                    <td>
                        <!-- ✅ Muestra el código del cupón si existe -->
                        <span *ngIf="promotion.couponCode; else noCode">
                            <code>{{ promotion.couponCode }}</code>
                        </span>
                        <ng-template #noCode>
                            <span style="color: #999;">N/A</span>
                        </ng-template>
                    </td>
                    <td>{{ formatDiscountValue(promotion) }}</td>
                    <td>{{ formatDate(promotion.startDate) }} - {{ formatDate(promotion.endDate) }}</td>
                    <td>
                        <nz-tag [nzColor]="promotion.isActive ? 'green' : 'default'">
                            {{ promotion.isActive ? 'Activa' : 'Inactiva' }}
                        </nz-tag>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button nz-button nzType="primary" nzSize="small"
                                (click)="openEditPromotionModal(promotion)" nz-tooltip nzTooltipTitle="Editar">
                                <span nz-icon nzType="edit"></span>
                            </button>
                            <button nz-button nzType="primary" nzDanger nzSize="small" nz-popconfirm
                                nzPopconfirmTitle="¿Está seguro de eliminar esta promoción?"
                                nzPopconfirmPlacement="bottom" (nzOnConfirm)="deletePromotion(promotion.id)" nz-tooltip
                                nzTooltipTitle="Eliminar">
                                <span nz-icon nzType="delete"></span>
                            </button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </nz-table>
    </nz-card>
</div>

<nz-modal [(nzVisible)]="formModalVisible" [nzTitle]="isEditMode ? 'Editar Plantilla' : 'Crear Nueva Plantilla'"
    [nzWidth]="800" (nzOnCancel)="closeFormModal()" [nzFooter]="modalFooter">
    <ng-container *nzModalContent>
        <nz-steps *ngIf="currentStep > 0" [nzCurrent]="0" nzSize="small" class="mb-4">
            <nz-step nzTitle="Tipo de Plantilla"></nz-step>
            <nz-step nzTitle="Configuración"></nz-step>
        </nz-steps>

        <form [formGroup]="promotionForm" nz-form>
            <div *ngIf="currentStep === 0" class="step-container">
                <h3 class="step-title">¿Qué tipo de plantilla deseas crear?</h3>
                <div nz-row [nzGutter]="16">
                    <div nz-col [nzSpan]="12">
                        <div class="selection-card" (click)="selectPromotionType('standard')">
                            <span nz-icon nzType="tags" nzTheme="outline"></span>
                            <h4>Promoción para Productos</h4>
                            <p>Crea una plantilla de descuento (ej: 20% OFF) que luego aplicarás manualmente a productos
                                específicos.</p>
                        </div>
                    </div>
                    <div nz-col [nzSpan]="12">
                        <div class="selection-card" (click)="selectPromotionType('coupon')">
                            <span nz-icon nzType="gift" nzTheme="outline"></span>
                            <h4>Código de Descuento</h4>
                            <p>Crea un código (ej: BIENVENIDA10) para que los clientes lo usen en el carrito de compras.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div *ngIf="currentStep === 1" class="step-container">
                <div nz-row [nzGutter]="16">
                    <div nz-col [nzSpan]="12">
                        <nz-form-item>
                            <nz-form-label nzRequired>Nombre (Uso interno)</nz-form-label>
                            <nz-form-control nzErrorTip="El nombre es requerido">
                                <input nz-input formControlName="name" />
                            </nz-form-control>
                        </nz-form-item>

                        <nz-form-item>
                            <nz-form-label>Descripción (Opcional)</nz-form-label>
                            <nz-form-control>
                                <textarea nz-input formControlName="description"
                                    [nzAutosize]="{ minRows: 2, maxRows: 4 }"></textarea>
                            </nz-form-control>
                        </nz-form-item>

                        <nz-form-item>
                            <nz-form-label nzRequired>Fechas de Validez</nz-form-label>
                            <nz-form-control nzErrorTip="Seleccione un rango de fechas">
                                <nz-range-picker formControlName="dates" style="width: 100%;"></nz-range-picker>
                            </nz-form-control>
                        </nz-form-item>
                    </div>

                    <div nz-col [nzSpan]="12">
                        <nz-form-item>
                            <nz-form-label nzRequired>Tipo de Descuento</nz-form-label>
                            <nz-select *ngIf="promotionForm.get('promotionType')?.value === 'standard'"
                                formControlName="discountType">
                                <nz-option nzValue="percentage" nzLabel="Porcentaje (%)"></nz-option>
                                <nz-option nzValue="fixed" nzLabel="Monto Fijo ($)"></nz-option>
                            </nz-select>
                            <nz-select *ngIf="promotionForm.get('promotionType')?.value === 'coupon'"
                                formControlName="discountType">
                                <nz-option nzValue="percentage" nzLabel="Porcentaje (%)"></nz-option>
                                <nz-option nzValue="fixed" nzLabel="Monto Fijo ($)"></nz-option>
                                <nz-option nzValue="shipping" nzLabel="Envío Gratis"></nz-option>
                            </nz-select>
                        </nz-form-item>

                        <nz-form-item *ngIf="promotionForm.get('discountType')?.value !== 'shipping'">
                            <nz-form-label nzRequired>Valor del Descuento</nz-form-label>
                            <nz-form-control nzErrorTip="El valor es requerido">
                                <nz-input-number formControlName="discountValue" [nzMin]="0.01"
                                    style="width: 100%;"></nz-input-number>
                            </nz-form-control>
                        </nz-form-item>

                        <nz-form-item>
                            <nz-form-label>Estado</nz-form-label>
                            <nz-form-control>
                                <nz-switch formControlName="isActive" nzCheckedChildren="Activa"
                                    nzUnCheckedChildren="Inactiva"></nz-switch>
                            </nz-form-control>
                        </nz-form-item>
                    </div>
                </div>

                <div *ngIf="promotionForm.get('promotionType')?.value === 'coupon'">
                    <nz-divider nzText="Condiciones del Código" nzOrientation="left"></nz-divider>
                    <div nz-row [nzGutter]="16">
                        <div nz-col [nzSpan]="16">
                            <nz-form-item>
                                <nz-form-label nzRequired>Código de Cupón</nz-form-label>
                                <nz-form-control nzErrorTip="El código es requerido">
                                    <input nz-input formControlName="couponCode" placeholder="VERANO25" />
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                    </div>
                    <div nz-row [nzGutter]="24">
                        <div nz-col [nzSpan]="12">
                            <nz-form-item>
                                <nz-form-label>Monto Mínimo de Compra</nz-form-label>
                                <nz-form-control>
                                    <nz-input-number formControlName="minPurchaseAmount" [nzMin]="0"
                                        style="width: 100%;" placeholder="Opcional"></nz-input-number>
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                        <div nz-col [nzSpan]="12">
                            <nz-form-item>
                                <nz-form-label>Descuento Máximo ($)</nz-form-label>
                                <nz-form-control>
                                    <nz-input-number formControlName="maxDiscountAmount" [nzMin]="0"
                                        style="width: 100%;" placeholder="Opcional"></nz-input-number>
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                    </div>
                    <div nz-row [nzGutter]="24" formGroupName="usageLimits">
                        <div nz-col [nzSpan]="12">
                            <nz-form-item>
                                <nz-form-label>Límite de Usos por Usuario</nz-form-label>
                                <nz-form-control>
                                    <nz-input-number formControlName="perUser" [nzMin]="1" style="width: 100%;"
                                        placeholder="Opcional, ej: 1"></nz-input-number>
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                        <div nz-col [nzSpan]="12">
                            <nz-form-item>
                                <nz-form-label>Límite de Usos Global</nz-form-label>
                                <nz-form-control>
                                    <nz-input-number formControlName="global" [nzMin]="1" style="width: 100%;"
                                        placeholder="Opcional, ej: 100"></nz-input-number>
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </ng-container>

    <ng-template #modalFooter>
        <button *ngIf="currentStep > 0" nz-button (click)="prevStep()">Anterior</button>
        <button *ngIf="currentStep === 1" nz-button nzType="primary" (click)="submitForm()" [nzLoading]="submitting"
            [disabled]="promotionForm.invalid">
            {{ isEditMode ? 'Guardar Cambios' : 'Crear Plantilla' }}
        </button>
    </ng-template>
</nz-modal>