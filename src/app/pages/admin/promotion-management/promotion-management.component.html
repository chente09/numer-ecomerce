<div class="promotions-container">
    <!-- Encabezado de la sección -->
    <nz-card nzTitle="Gestión de Promociones y Cupones" class="mb-4 header-card">
        <div class="card-actions">
            <button nz-button nzType="primary" (click)="openCreatePromotionModal()">
                <span nz-icon nzType="plus"></span>
                <span class="button-text">Nueva Promoción / Cupón</span>
            </button>
        </div>
    </nz-card>

    <nz-card *ngIf="!loading">
        <nz-table #promotionsTable [nzData]="promotions" [nzBordered]="true" [nzShowPagination]="promotions.length > 10"
            [nzPageSize]="10" *ngIf="promotions.length > 0">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Tipo General</th>
                    <th>Código</th>
                    <th>Descuento</th>
                    <th>Fechas</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let promotion of promotionsTable.data">
                    <td>
                        <div class="promotion-name">
                            <strong>{{ promotion.name }}</strong>
                            <div *ngIf="promotion.description" class="promotion-description">
                                {{ promotion.description }}
                            </div>
                        </div>
                    </td>
                    <td>
                        <!-- ✅ Muestra si es Estándar o Cupón -->
                        <nz-tag [nzColor]="promotion.promotionType === 'coupon' ? 'gold' : 'blue'">
                            {{ promotion.promotionType === 'coupon' ? 'Cupón' : 'Estándar' }}
                        </nz-tag>
                    </td>
                    <td>
                        <!-- ✅ Muestra el código del cupón si existe -->
                        <span *ngIf="promotion.couponCode; else noCode">
                            <code>{{ promotion.couponCode }}</code>
                        </span>
                        <ng-template #noCode>
                            <span style="color: #999;">N/A</span>
                        </ng-template>
                    </td>
                    <td>{{ formatDiscountValue(promotion) }}</td>
                    <td>{{ formatDate(promotion.startDate) }} - {{ formatDate(promotion.endDate) }}</td>
                    <td>
                        <nz-tag [nzColor]="promotion.isActive ? 'green' : 'default'">
                            {{ promotion.isActive ? 'Activa' : 'Inactiva' }}
                        </nz-tag>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button nz-button nzType="primary" nzSize="small"
                                (click)="openEditPromotionModal(promotion)" nz-tooltip nzTooltipTitle="Editar">
                                <span nz-icon nzType="edit"></span>
                            </button>
                            <button nz-button nzType="primary" nzDanger nzSize="small" nz-popconfirm
                                nzPopconfirmTitle="¿Está seguro de eliminar esta promoción?"
                                nzPopconfirmPlacement="bottom" (nzOnConfirm)="deletePromotion(promotion.id)" nz-tooltip
                                nzTooltipTitle="Eliminar">
                                <span nz-icon nzType="delete"></span>
                            </button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </nz-table>
    </nz-card>
</div>

<!-- Modal de formulario para crear/editar promoción -->
<nz-modal [(nzVisible)]="formModalVisible" [nzTitle]="isEditMode ? 'Editar Promoción' : 'Asistente de Nueva Promoción'"
    [nzWidth]="800" (nzOnCancel)="closeFormModal()" [nzFooter]="modalFooter"> <ng-container *nzModalContent>
        <nz-steps [nzCurrent]="currentStep" class="mb-4">
            <nz-step nzTitle="Tipo"></nz-step>
            <nz-step nzTitle="Beneficio"></nz-step>
            <nz-step nzTitle="Condiciones"></nz-step>
        </nz-steps>

        <form [formGroup]="promotionForm" nz-form>
            <div *ngIf="currentStep === 0" class="step-container">
                <h3 class="step-title">¿Qué deseas crear?</h3>
                <div nz-row [nzGutter]="16">
                    <div nz-col [nzSpan]="12">
                        <div class="selection-card" (click)="selectPromotionType('standard')">
                            <span nz-icon nzType="tags" nzTheme="outline"></span>
                            <h4>Promoción Estándar</h4>
                            <p>Un descuento que aplicas manualmente a productos. Ideal para rebajas de temporada.</p>
                        </div>
                    </div>
                    <div nz-col [nzSpan]="12">
                        <div class="selection-card" (click)="selectPromotionType('coupon')">
                            <span nz-icon nzType="gift" nzTheme="outline"></span>
                            <h4>Código de Descuento (Cupón)</h4>
                            <p>Un código único que los clientes usan en el carrito. Ideal para campañas de marketing.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div *ngIf="currentStep === 1" class="step-container">
                <h3 class="step-title">¿Cuál es el beneficio de la promoción?</h3>
                <div nz-row [nzGutter]="16">
                    <div nz-col [nzXs]="24" [nzSm]="12">
                        <nz-form-item>
                            <nz-form-label nzRequired>Nombre</nz-form-label>
                            <nz-form-control nzErrorTip="Por favor ingrese un nombre (mín. 5 caracteres)">
                                <input nz-input formControlName="name" placeholder="Ej: Descuento de Verano" />
                            </nz-form-control>
                        </nz-form-item>

                        <nz-form-item>
                            <nz-form-label>Descripción</nz-form-label>
                            <nz-form-control>
                                <textarea nz-input formControlName="description"
                                    [nzAutosize]="{ minRows: 2, maxRows: 4 }"></textarea>
                            </nz-form-control>
                        </nz-form-item>
                    </div>

                    <div nz-col [nzXs]="24" [nzSm]="12">
                        <nz-form-item>
                            <nz-form-label nzRequired>Tipo de Descuento</nz-form-label>
                            <nz-form-control>
                                <nz-select formControlName="discountType">
                                    <nz-option nzValue="percentage" nzLabel="Porcentaje (%)"></nz-option>
                                    <nz-option nzValue="fixed" nzLabel="Monto Fijo ($)"></nz-option>
                                    <nz-option nzValue="shipping" nzLabel="Envío Gratis"></nz-option>
                                </nz-select>
                            </nz-form-control>
                        </nz-form-item>

                        <nz-form-item *ngIf="promotionForm.get('discountType')?.value !== 'shipping'">
                            <nz-form-label nzRequired>Valor del Descuento</nz-form-label>
                            <nz-form-control nzErrorTip="Ingrese un valor válido">
                                <nz-input-number formControlName="discountValue" [nzMin]="0" [nzStep]="1"
                                    style="width: 100%;"></nz-input-number>
                            </nz-form-control>
                        </nz-form-item>
                    </div>
                </div>
            </div>

            <div *ngIf="currentStep === 2" class="step-container">
                <h3 class="step-title">¿Bajo qué condiciones aplica?</h3>
                <div nz-row [nzGutter]="16">
                    <div nz-col [nzXs]="24" [nzSm]="12">
                        <nz-form-item>
                            <nz-form-label nzRequired>Fecha de Inicio</nz-form-label>
                            <nz-form-control nzErrorTip="Seleccione una fecha de inicio">
                                <nz-date-picker formControlName="startDate" style="width: 100%;"></nz-date-picker>
                            </nz-form-control>
                        </nz-form-item>

                        <nz-form-item>
                            <nz-form-label nzRequired>Fecha de Fin</nz-form-label>
                            <nz-form-control nzErrorTip="Seleccione una fecha de fin">
                                <nz-date-picker formControlName="endDate" style="width: 100%;"></nz-date-picker>
                            </nz-form-control>
                        </nz-form-item>

                        <nz-form-item>
                            <nz-form-label>Estado</nz-form-label>
                            <nz-form-control>
                                <nz-switch formControlName="isActive" nzCheckedChildren="Activa"
                                    nzUnCheckedChildren="Inactiva"></nz-switch>
                            </nz-form-control>
                        </nz-form-item>
                    </div>

                    <div nz-col [nzXs]="24" [nzSm]="12">
                        <nz-form-item>
                            <nz-form-label>Monto Mínimo de Compra ($)</nz-form-label>
                            <nz-form-control>
                                <nz-input-number formControlName="minPurchaseAmount" [nzMin]="0"
                                    style="width: 100%;"></nz-input-number>
                            </nz-form-control>
                        </nz-form-item>
                    </div>
                </div>

                <div *ngIf="promotionForm.get('promotionType')?.value === 'coupon'">
                    <nz-divider nzText="Configuración Específica del Cupón" nzOrientation="left"></nz-divider>
                    <div nz-row [nzGutter]="16">
                        <div nz-col [nzXs]="24" [nzSm]="12">
                            <nz-form-item>
                                <nz-form-label nzRequired>Código del Cupón</nz-form-label>
                                <nz-form-control
                                    nzErrorTip="El código es requerido, 4+ caracteres, solo mayúsculas y números (ej: VERANO25)">
                                    <input nz-input formControlName="couponCode" placeholder="BIENVENIDA10" />
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                        <div nz-col [nzXs]="24" [nzSm]="12">
                            <nz-form-item>
                                <nz-form-label>Límite de Usos por Usuario</nz-form-label>
                                <nz-form-control nzErrorTip="Debe ser un número mayor a 0">
                                    <nz-input-number formControlName="usageLimits.perUser" [nzMin]="1"
                                        placeholder="Ej: 1 (un solo uso por cliente)"
                                        style="width: 100%;"></nz-input-number>
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </ng-container>

    <ng-template #modalFooter>
        <button *ngIf="currentStep > 0" nz-button (click)="prevStep()">
            <span nz-icon nzType="left"></span>
            Anterior
        </button>

        <button *ngIf="currentStep < 2" nz-button nzType="primary" (click)="currentStep = currentStep + 1"
            [disabled]="!isCurrentStepValid()">
            Siguiente
            <span nz-icon nzType="right"></span>
        </button>

        <button *ngIf="currentStep === 2" nz-button nzType="primary" (click)="submitForm()" [nzLoading]="submitting">
            Guardar Promoción
        </button>
    </ng-template>
</nz-modal>