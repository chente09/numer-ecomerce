<div class="carrito-container">

  <!-- Header minimalista -->
  <div class="carrito-header" *ngIf="!loading && cart && cart.items.length > 0">
    <h1 class="carrito-title">Equipamiento Seleccionado</h1>
    <div class="cart-stats" *ngIf="cart && cart.items.length > 0">
      <div class="stat-item">
        <span class="stat-label">Productos</span>
        <span class="stat-value">{{ cart.totalItems }}</span>
      </div>
      <div class="stat-item" *ngIf="hasDiscounts()">
        <span class="stat-label">Ahorros</span>
        <span class="stat-value">${{ getTotalSavings().toFixed(2) }}</span>
      </div>
    </div>
  </div>

  <!-- Loading state -->
  <div *ngIf="loading" class="loading-container">
    <nz-spin nzSize="large"></nz-spin>
  </div>

  <!-- Carrito vacío -->
  <div *ngIf="!loading && (!cart || cart.items.length === 0)" class="empty-cart">
    <div class="empty-cart-icon">
      <span nz-icon nzType="shopping-cart" nzTheme="outline"></span>
    </div>
    <h2>Carrito Vacío</h2>
    <p>Explora nuestro catálogo y encuentra productos para tu próxima aventura.</p>
    <button nz-button nzSize="large" (click)="continueShopping()" class="continue-shopping-button">
      Explorar Catálogo
    </button>
  </div>

  <!-- Layout principal: Items + Sidebar -->
  <div *ngIf="!loading && cart && cart.items.length > 0" class="cart-content">

    <!-- Sección de items (lado izquierdo) -->
    <div class="cart-items-section">
      <div class="cart-items">

        <div *ngFor="let item of cart.items; trackBy: trackByVariantId" class="cart-item">

          <!-- Imagen del producto -->
          <div class="item-image">
            <img [src]="item.product?.imageUrl" [alt]="item.product?.name" class="product-thumbnail"
              (error)="handleImageError($event)" />
          </div>

          <!-- Información del producto -->
          <div class="item-info">
            <h4 class="product-name">{{ item.product?.name }}</h4>
            <p class="product-category">{{ item.product?.category }}</p>

            <div class="variant-info">
              <span class="color-indicator" [style.background-color]="item.variant?.colorCode"></span>
              <span class="variant-text">{{ item.variant?.colorName }} / {{ item.variant?.sizeName }}</span>
            </div>

            <div class="unit-price">${{ item.unitPrice | number:'1.2-2' }}</div>
          </div>

          <!-- Controles -->
          <div class="item-controls">

            <!-- Cantidad -->
            <div class="quantity-section">
              <span class="quantity-label">Cantidad</span>
              <div class="quantity-selector">
                <button class="qty-btn" [disabled]="updating || item.quantity <= 1"
                  (click)="updateQuantity(item, item.quantity - 1)">−</button>

                <input class="qty-value" [(ngModel)]="item.quantity" [disabled]="updating"
                  (change)="updateQuantity(item, item.quantity)" type="number" min="1"
                  [max]="item.variant?.stock || 10">

                <button class="qty-btn" [disabled]="updating || item.quantity >= (item.variant?.stock || 0)"
                  (click)="updateQuantity(item, item.quantity + 1)">+</button>
              </div>
            </div>

            <!-- Total y eliminar -->
            <div class="item-total-section">
              <div class="total-price">${{ item.totalPrice | number:'1.2-2' }}</div>
              <button class="remove-item" (click)="removeItem(item)" [disabled]="updating">
                <span nz-icon nzType="close" nzTheme="outline"></span>
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Sidebar derecho - Resumen fijo -->
    <div class="summary-right">
      <div class="summary-card">

        <!-- Título -->
        <h4 class="summary-title">Resumen</h4>

        <!-- Código de descuento -->
        <div class="discount-section">
          <h5>Código de Descuento</h5>
          <div class="discount-input-group">
            <input class="discount-input" placeholder="Código" [(ngModel)]="discountCode" [disabled]="updating">
            <button class="discount-btn" (click)="applyDiscount()" [disabled]="updating || !discountCode.trim()">
              Aplicar
            </button>
          </div>
        </div>

        <!-- Totales -->
        <div class="summary-totals">
          <div class="summary-row">
            <span class="summary-label">Subtotal</span>
            <span class="summary-value">${{ cart.subtotal | number:'1.2-2' }}</span>
          </div>

          <div class="summary-row" *ngIf="cart.discount > 0">
            <span class="summary-label">Descuento</span>
            <span class="summary-value">-${{ cart.discount | number:'1.2-2' }}</span>
          </div>

          <div class="summary-row">
            <span class="summary-label">IVA</span>
            <span class="summary-value">${{ cart.tax | number:'1.2-2' }}</span>
          </div>

          <div class="summary-row">
            <span class="summary-label">Envío</span>
            <span class="summary-value">
              <span *ngIf="cart.shipping > 0">${{ cart.shipping | number:'1.2-2' }}</span>
              <span *ngIf="cart.shipping === 0">Gratis</span>
            </span>
          </div>

          <div class="summary-row total-row">
            <span class="summary-label">Total</span>
            <span class="summary-value">${{ cart.total | number:'1.2-2' }}</span>
          </div>
        </div>

        <!-- Checkout -->
        <div class="checkout-section">

          <!-- No autenticado -->
          <div *ngIf="!currentUser" class="auth-notice">
            <p>Inicia sesión para continuar</p>
            <button class="auth-button" (click)="redirectToLogin()">
              Iniciar Sesión
            </button>
          </div>

          <!-- Usuario anónimo -->
          <div *ngIf="currentUser?.isAnonymous" class="auth-notice">
            <p>Completa tu registro</p>
            <button class="auth-button" (click)="redirectToCompleteProfile()">
              Completar Registro
            </button>
          </div>

          <!-- Usuario registrado -->
          <div *ngIf="currentUser && !currentUser.isAnonymous">
            <button class="checkout-button" [disabled]="!cart || cart.items.length === 0 || updating || !canCheckout"
              (click)="proceedToCheckout()">
              <span *ngIf="!processingCheckout">Proceder al Pago</span>
              <span *ngIf="processingCheckout">Procesando...</span>
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Acciones flotantes (móvil) -->
  <div class="cart-actions" *ngIf="cart && cart.items.length > 0">
    <button class="floating-action" (click)="clearCart()" [disabled]="updating">
      Vaciar
    </button>
    <button class="floating-action" (click)="continueShopping()">
      Continuar
    </button>
  </div>

</div>