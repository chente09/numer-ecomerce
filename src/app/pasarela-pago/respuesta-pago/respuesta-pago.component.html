<div class="payment-layout">
  
  <!-- Main content - Full width para respuesta -->
  <main class="payment-main full-width">
    
    <!-- Header con pasos DINÁMICO -->
    <header class="payment-header">
      <div class="progress-container">
        <nz-steps [nzCurrent]="2" nzSize="small" class="payment-steps">
          <nz-step nzTitle="Carrito" nzIcon="shopping-cart"></nz-step>
          <nz-step nzTitle="Pago" nzIcon="credit-card"></nz-step>
          <nz-step nzTitle="Confirmación" nzIcon="check-circle"></nz-step>
        </nz-steps>
      </div>

      <!-- Título dinámico -->
      <h1 class="main-title">
        <ng-container *ngIf="loading">Procesando...</ng-container>
        <ng-container *ngIf="!loading && resultado && !isCanceled()">¡Compra exitosa!</ng-container>
        <ng-container *ngIf="!loading && resultado && isCanceled()">Pago cancelado</ng-container>
        <ng-container *ngIf="!loading && error">Error en el pago</ng-container>
      </h1>
    </header>

    <!-- Contenido de confirmación -->
    <div class="confirmation-content">
      
      <!-- Loading de confirmación -->
      <div *ngIf="loading" class="confirmation-loading">
        <div class="loading-state">
          <div class="spinner-container">
            <nz-spin nzSize="large" nzTip="Procesando tu compra..."></nz-spin>
          </div>
          <p class="processing-message">Confirmando pago y actualizando inventario...</p>
        </div>
      </div>

      <!-- Error en confirmación -->
      <div *ngIf="!loading && error" class="confirmation-error">
        <nz-result 
          nzStatus="error" 
          nzTitle="Error al confirmar el pago"
          [nzSubTitle]="'Hubo un problema procesando tu transacción'">
          <div nz-result-extra>
            <nz-alert
              nzType="info"
              nzMessage="💬 Puedes contactarnos por WhatsApp para ayuda inmediata"
              nzShowIcon
              class="whatsapp-notice">
            </nz-alert>
            
            <div class="error-details">
              <nz-collapse>
                <nz-collapse-panel nzHeader="Ver detalles del error">
                  <pre>{{ error | json }}</pre>
                </nz-collapse-panel>
              </nz-collapse>
            </div>

            <div class="error-actions">
              <button nz-button nzType="default" (click)="goToMainFlow()">
                <span nz-icon nzType="shop"></span>
                Ir a tienda
              </button>
            </div>
          </div>
        </nz-result>
      </div>

      <!-- Ticket exitoso -->
      <div *ngIf="!loading && resultado && !error" class="ticket-container">
        
        <!-- Cancelado -->
        <div *ngIf="isCanceled()" class="canceled-notice">
          <nz-result
            nzStatus="info"
            nzTitle="Pago Cancelado"
            nzSubTitle="La transacción ha sido cancelada y no se ha realizado ningún cargo.">
            <div nz-result-extra>
              <button nz-button nzType="primary" (click)="goToMainFlow()">
                <span nz-icon nzType="shopping"></span>
                Continuar comprando
              </button>
            </div>
          </nz-result>
        </div>

        <!-- Exitoso -->
        <div *ngIf="!isCanceled()" class="success-ticket">
          
          <!-- Header de éxito -->
          <div class="ticket-header">
            <nz-result
              nzStatus="success"
              nzTitle="¡Pago Exitoso!"
              nzSubTitle="Tu compra ha sido procesada correctamente">
            </nz-result>
          </div>

          <!-- Detalles de la transacción -->
          <nz-card nzTitle="Detalles de la transacción" class="ticket-details">
            <div class="detail-grid">
              
              <!-- Detalles principales -->
              <div class="detail-item highlight">
                <span class="label">Estado:</span>
                <nz-tag [nzColor]="'green'">{{ friendlyStatus }}</nz-tag>
              </div>
              
              <div class="detail-item highlight">
                <span class="label">Monto:</span>
                <strong class="amount">{{ (resultado.amount/100) | currency:currencyCode:'symbol':'1.2-2' }}</strong>
              </div>
              
              <div class="detail-item">
                <span class="label">ID Transacción:</span>
                <code class="transaction-id">{{ resultado.transactionId }}</code>
              </div>
              
              <div class="detail-item">
                <span class="label">Fecha:</span>
                <span>{{ resultado.date | date:'medium' }}</span>
              </div>

              <div class="detail-item" *ngIf="resultado.authorizationCode">
                <span class="label">Código de Autorización:</span>
                <code>{{ resultado.authorizationCode }}</code>
              </div>

              <!-- Más detalles colapsables -->
              <div class="detail-item full-width">
                <nz-collapse class="detail-collapse">
                  <nz-collapse-panel nzHeader="Ver información completa">
                    <div class="extended-details">
                      
                      <div class="detail-row" *ngIf="resultado.clientTransactionId">
                        <span>ID Cliente:</span> 
                        <code>{{ resultado.clientTransactionId }}</code>
                      </div>
                      
                      <div class="detail-row" *ngIf="resultado.currency">
                        <span>Moneda:</span> 
                        <span>{{ resultado.currency }}</span>
                      </div>
                      
                      <div class="detail-row" *ngIf="resultado.reference">
                        <span>Referencia:</span> 
                        <span>{{ resultado.reference }}</span>
                      </div>
                      
                      <div class="detail-row" *ngIf="resultado.email">
                        <span>Email:</span> 
                        <span>{{ resultado.email }}</span>
                      </div>
                      
                      <div class="detail-row" *ngIf="resultado.phoneNumber">
                        <span>Teléfono:</span> 
                        <span>{{ resultado.phoneNumber }}</span>
                      </div>
                      
                      <div class="detail-row" *ngIf="resultado.document">
                        <span>Documento:</span> 
                        <span>{{ resultado.document }}</span>
                      </div>
                      
                      <div class="detail-row" *ngIf="resultado.cardBrand">
                        <span>Tarjeta:</span> 
                        <span>{{ resultado.cardBrand }} 
                          <span *ngIf="resultado.cardType">({{ resultado.cardType }})</span>
                          <span *ngIf="resultado.lastDigits"> **** {{ resultado.lastDigits }}</span>
                        </span>
                      </div>
                      
                      <div class="detail-row" *ngIf="resultado.storeName">
                        <span>Comercio:</span> 
                        <span>{{ resultado.storeName }}</span>
                      </div>
                      
                      <div class="detail-row" *ngIf="resultado.optionalParameter3">
                        <span>Nota:</span> 
                        <span>{{ resultado.optionalParameter3 }}</span>
                      </div>
                      
                      <div class="detail-row" *ngIf="resultado.optionalParameter4">
                        <span>Cliente:</span> 
                        <span>{{ resultado.optionalParameter4 }}</span>
                      </div>
                      
                    </div>
                  </nz-collapse-panel>
                </nz-collapse>
              </div>
            </div>
          </nz-card>

          <!-- Acciones -->
          <div class="ticket-actions">
            <button nz-button nzSize="large" (click)="printTicket()">
              <span nz-icon nzType="printer"></span>
              Imprimir comprobante
            </button>
            
            <button nz-button nzType="primary" nzSize="large" (click)="goToMainFlow()">
              <span nz-icon nzType="shopping"></span>
              Seguir comprando
            </button>
          </div>

        </div>
      </div>

    </div>

  </main>
</div>